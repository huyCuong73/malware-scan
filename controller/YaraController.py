from flask_restful import Resource
from flask import request, jsonify
from context import Context

import yara
import json
import datetime



class YaraController(Resource):


    def get(self):
        data = request.json
        print(data)
        return '1223'


    def post(self):
        data = request.json
  
        filePath = data['filePath']

        matches = []
    
        severity = "none"

        hints = ["APT", "RANSOM", "RSA", "SHA", "AES"]

        try:

            for rules in Context.compiledRules:
                if(rules.match(filePath)):
                    for rule in rules:
                        matches.append(rule.identifier)
                            
                        if(rule.identifier in Context.classifyRules):
                            severity = "high"
                                 

        except yara.Error as e:
            print(f"Error scanning file: {e}")
  
        return jsonify({
            "filePath": filePath,
            "matchedRules": matches,
            "severity":severity
        })